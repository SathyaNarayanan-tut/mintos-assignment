README for Automating SonarQube and PostgreSQL Deployment

Overview :

In this assignment, the goal was to automate the deployment of SonarQube and PostgreSQL on an AWS EC2 instance using Terraform and Bash scripting. Initially, I manually tested the deployment on my local machine and AWS EC2 instance to ensure everything worked as expected. After successful manual testing, I automated the entire process using the Bash script and Terraform configuration.

This README outlines the prerequisites, setup steps, and the flow of the automated deployment process.

Prerequisites :
Before you begin, ensure that you have the following:

AWS EC2 Instance

Instance Type: t2.xlarge
OS: Ubuntu 22.04
CPUs: 4 vCPUs
Memory: 16 GB RAM
SonarQube and PostgreSQL will be deployed on this instance.

Installed Tools

Docker (for containerized deployment of SonarQube)
Minikube (for local Kubernetes cluster setup)
kubectl (to manage the Kubernetes cluster)
Helm (for managing Kubernetes applications)
Terraform (for infrastructure automation)
Make sure you have a working AWS account, and your EC2 instance should be ready with SSH access.

Preparing the AWS EC2 Instance :

Launch an AWS EC2 instance with Ubuntu 22.04, 4 CPUs, and 16 GB RAM (t2.xlarge).
SSH into the EC2 instance using your credentials.

Installing Dependencies :

In this step, we need to install the necessary tools for Docker, Minikube, kubectl, Helm, and Terraform. These tools are essential for deploying and managing SonarQube and PostgreSQL on AWS EC2, and their installation is automated through the Bash script. The script first installs Docker and adds the current user to the Docker group. After running the script, you will need to log out and log back in, or run newgrp docker to apply the group changes. 

Next, the script automates the installation of Minikube, kubectl, and Helm. Minikube will be used to set up a local Kubernetes cluster on the EC2 instance, and Helm will be used to manage Kubernetes applications, including SonarQube and PostgreSQL. Finally, Terraform is installed to automate the provisioning of infrastructure. The script installs Terraform using the official HashiCorp package repository, allowing for easy and consistent infrastructure management.

Running the Bash Script :

After installing the necessary dependencies, the next step is to run the setup.sh script. 
First, ensure the script is executable by running the following command:

chmod +x setup.sh
./setup.sh

This script automates several critical tasks required to set up the environment. It first installs Docker, Minikube, kubectl, Helm, and Terraform. Then, it starts a Minikube Kubernetes cluster using Docker as the driver. Once the Kubernetes cluster is up and running, the script proceeds to deploy SonarQube and PostgreSQL onto the local Kubernetes cluster. For deploying SonarQube, the script uses the official Helm chart instead of the previously popular Oteemo SonarQube Helm chart. The Oteemo chart is now deprecated and no longer maintained, which is why the official Helm chart is used for better support and updates. After deploying SonarQube, the script also initializes and applies Terraform configurations to provision the required infrastructure on AWS.

After the initial run, if Docker is installed, the script checks whether the user is part of the Docker group. If not, it prompts you to log out and log back in or run the newgrp docker command to apply the group changes. This is necessary because Docker commands require appropriate user permissions. Once this is done, you will need to re-run the setup.sh script to continue with the automation process. The reason for this is that Docker requires a session refresh to recognize the user as part of the Docker group, allowing Docker-related operations to proceed without requiring root privileges.

Terraform Configuration :

The Terraform configuration files, namely main.tf, variables.tf, providers.tf and outputs.tf, define the infrastructure that Terraform will manage. However, for security and privacy reasons, the terraform.tfvars and terraform.tfstate files have not been included in this repository. 
These files contain sensitive information, and it is recommended not to commit them to public repositories. 
The terraform.tfvars file typically holds sensitive data such as API keys, passwords, and other credentials, which should be created locally and populated with appropriate values (e.g., postgresql password, sonarqube settings, VPC settings) before running terraform apply. 

Create a terraform.tfvars file on your local machine with the necessary variable values, based on the infrastructure you are provisioning.
The terraform.tfstate file will be automatically generated by Terraform when you run terraform apply.
Once the terraform.tfvars file is created and the other Terraform files are configured, you can initialize the Terraform :

terraform init
terraform apply -auto-approve


Verifying Deployment :

After running the script, use the following commands to verify the deployment of SonarQube and PostgreSQL:

kubectl get pods -n database
kubectl get svc -n database
kubectl get ingress -n database

Check that the services are running and accessible. If everything is successful, SonarQube and PostgreSQL should be up and running on your local Kubernetes cluster.

Conclusion :

This automated deployment process simplifies the setup of SonarQube and PostgreSQL on AWS EC2 using Docker, Minikube, kubectl, Helm, and Terraform. By using this approach, you can quickly replicate the setup across different environments, ensuring a consistent and efficient deployment process.

